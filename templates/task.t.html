{% extends "base.t.html" %}
{% from 'task_table.t.html' import render_task_table %}
{% block title %}{{ task.summary if task.summary != None }} - {{ super() }}{% endblock %}
{% block header_sub_text %}{{ task.summary if task.summary != None }}{% endblock %}
{% block content %}
<div class="container">
<div>
    <a class="btn btn-primary" href="{{ url_for('edit_task', id=task.id) }}">Edit</a>
    <p></p>
    <table class="task_info">
        <tr><td>ID</td><td>{{ task.id }}</td></tr>
        <tr><td>Summary</td><td>{{ task.summary|d }}</td></tr>
        <tr><td>Description</td><td><div class="task_description">{{ task.description|gfm if task.description != None }}</div></td></tr>
        <tr><td>Deadline</td><td>{{ task.deadline|d }}</td></tr>
        <tr>
            <td>Done?</td>
            <td>{{ task.is_done }}
                <small>
                    {% if task.is_done %}
                        <a href="{{ url_for('task_undo', id=task.id, next=url_for('view_task', id=task.id)) }}">(mark as not done)</a>
                    {% else %}
                        <a href="{{ url_for('task_done', id=task.id, next=url_for('view_task', id=task.id)) }}">(mark as done)</a>
                    {% endif %}
                </small>
            </td>
        </tr>
        <tr>
            <td>Deleted?</td>
            <td>{{ task.is_deleted }}
                <small>
                    {% if task.is_deleted %}
                        <a href="{{ url_for('undelete_task', id=task.id, next=url_for('view_task', id=task.id)) }}">(undelete)</a>
                    {% else %}
                        <a href="{{ url_for('delete_task', id=task.id, next=url_for('view_task', id=task.id)) }}">(delete)</a>
                    {% endif %}
                </small>
            </td>
        </tr>
        <tr><td>Order #</td><td>{{ task.order_num if task.order_num != None }}</td></tr>
        <tr><td>Expected duration</td><td>{{ task.get_expected_duration_for_viewing() }}</td></tr>
        <tr><td>Expected cost</td><td>${{ task.get_expected_cost_for_viewing() }}</td></tr>
        <tr>
            <td>Parent Task</td>
            <td>
                {% if task.parent_id != None %}
                <a href="{{ url_for('view_task', id=task.parent_id) }}">{{ task.parent.summary if task.parent != None }} ({{ task.parent_id if task.parent_id != None }})</a>
                {% else %}
                None
                {% endif %}
            </td>
        </tr>
        <tr>
            <td>Tags</td>
            <td>
                {% for ttl in task.tags %}
                    <a href="{{ url_for('view_tag', id=ttl.tag_id) }}">{{ ttl.value }}</a>
                    <a href="{{ url_for('delete_tag_from_task', id=task.id, tag_id=ttl.tag_id) }}">
                        <img src="{{ url_for('static', filename='delete.png') }}" />
                    </a>
                {% endfor %}
                <form action="{{ url_for('add_tag_to_task', id=task.id) }}" method="post">
                    <input type="text" name="value" />
                    <input type="hidden" name="next_url"
                           value="{{ url_for('view_task', id=task.id) }}" />
                </form>
            </td>
        </tr>
        <tr>
            <td>Authorized Users</td>
            <td>
                {% for tul in task.users %}
                    <a href="{{ url_for('view_user', user_id=tul.user_id) }}">{{ tul.email }}</a>
                    {% if task.users.count() > 1 %}
                    <a href="{{ url_for('deauthorize_user_for_task', task_id=task.id, user_id=tul.user_id) }}">
                        <img src="{{ url_for('static', filename='delete.png') }}" />
                    </a>
                    {% endif %}
                {% endfor %}
                <form action="{{ url_for('authorize_user_for_task', task_id=task.id) }}" method="post">
                    <input type="text" name="email" />
                    <input type="hidden" name="next_url"
                           value="{{ url_for('view_task', id=task.id) }}" />
                </form>
                <a href="{{ url_for('pick_user_to_authorize', task_id=task.id) }}">Pick a user</a>
            </td>
        </tr>
    </table>
    <p></p>
    <a class="btn btn-primary" href="{{ url_for('edit_task', id=task.id) }}">Edit</a>
    <p></p>
    <a class="btn btn-danger btn-xs" href="{{ url_for('convert_task_to_tag', id=task.id) }}">Convert to tag</a>
</div>
<div>
    <h4>Child Tasks</h4>

    {{ render_task_table(descendants, task, cycle,
        page_url=url_for('view_task', id=task.id),
        child_task_view='view_task',
        show_move_links=True,
        show_new_task_form=True, new_task_parent=task) }}
</div>
<div>
    <p>
        {%- if show_deleted %}
        <a href="{{ url_for('show_hide_deleted', show_deleted=0, next=url_for('view_task', id=task.id)) }}">hide deleted</a>
        {% else %}
        <a href="{{ url_for('show_hide_deleted', show_deleted=1, next=url_for('view_task', id=task.id)) }}">show deleted</a>
        {% endif -%}
    </p>
    <p>
        {%- if show_done %}
        <a href="{{ url_for('show_hide_done', show_done=0, next=url_for('view_task', id=task.id)) }}">hide done</a>
        {% else %}
        <a href="{{ url_for('show_hide_done', show_done=1, next=url_for('view_task', id=task.id)) }}">show done</a>
        {% endif -%}
    </p>
    <p>
        {%- if show_hierarchy %}
        <a href="{{ url_for('show_hide_hierarchy', show_hierarchy=0, next=url_for('view_task', id=task.id)) }}">hide hierarchy</a>
        {% else %}
        <a href="{{ url_for('show_hide_hierarchy', show_hierarchy=1, next=url_for('view_task', id=task.id)) }}">show hierarchy</a>
        {% endif -%}
    </p>
</div>
<div>
    <h4>Notes</h4>
    <table class="task_notes">
        <thead>
        <tr>
            <th>ID</th>
            <th>Timestamp</th>
            <th>Content</th>
        </tr>
        </thead>
        {% for note in task.notes %}
        <tr>
            <td>{{ note.id }}</td>
            <td>{{ note.timestamp }}</td>
            <td class="note_content">{{ note.content|gfm if note.content != None }}</td>
        </tr>
        {% endfor %}
        <tr>
            <td></td>
            <td></td>
            <td>
                <form action="{{ url_for('new_note') }}" method="post">
                    <input type="hidden" name="task_id" value="{{ task.id }}" />
                    <textarea name="content"></textarea><br/>
                    <input type="submit" value="Add New Note">
                </form>
            </td>
        </tr>
    </table>

</div>
<div>
    <h4>Attachments</h4>
    <table class="task_attachments">
        <thead>
        <tr>
            <th>ID</th>
            <th>Timestamp</th>
            <th>Filename</th>
            <th>Description</th>
        </tr>
        </thead>
        {% for att in task.attachments %}
        <tr>
            <td>{{ att.id }}</td>
            <td>{{ att.timestamp }}</td>
            <td><a href="{{ url_for('get_attachment', aid=att.id, x=att.filename) }}">{{ att.filename if att.filename != None }}</a></td>
            <td>{{ att.description }}</td>
        </tr>
        {% endfor %}
        <tr>
            <td></td>
            <td></td>
            <form action="{{ url_for('new_attachment') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="task_id" value="{{ task.id }}">
                <td>
                    <input type="file" name="filename" />
                </td>
                <td>
                    <input type="text" name="description" maxlength="100" />
                    <input type="submit" value="Attach" />
                </td>
            </form>
        </tr>
    </table>
</div>
</div>
{% endblock %}